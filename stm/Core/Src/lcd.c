/**
 * This file contains functions to initialize
 * and render different things to the LCD
 * screen on the BOOSTXL-EDUMKII.
 *
 * @author Brodie Abrew & Lucas Berry
 */

#include "lcd.h"
#include "bitmacro.h"
#include "spi.h"
#include "stm32l552xx.h"
#include "timer.h"

enum ST7735_COMMANDS {
  ST7735_NOP = 0x0,
  ST7735_SWRESET = 0x1,
  ST7735_SLPOUT = 0x11,
  ST7735_NORON = 0x13,
  ST7735_INVOFF = 0x20,
  ST7735_GAMSET = 0x26,
  ST7735_DISPON = 0x29,
  ST7735_CASET = 0x2A,
  ST7735_RASET = 0x2B,
  ST7735_RAMWR = 0x2C,
  ST7735_MADCTL = 0x36,
  ST7735_COLMOD = 0x3A,
  ST7735_FRMCTR1 = 0xB1,
  ST7735_FRMCTR2 = 0xB2,
  ST7735_FRMCTR3 = 0xB3,
  ST7735_INVCTR = 0xB4,
  ST7735_PWCTR1 = 0xC0,
  ST7735_PWCTR2 = 0xC1,
  ST7735_PWCTR3 = 0xC2,
  ST7735_PWCTR4 = 0xC3,
  ST7735_PWCTR5 = 0xC4,
  ST7735_VMCTR1 = 0xC5,
  ST7735_GMCTRP1 = 0xE0,
  ST7735_GMCTRN1 = 0xE1
};

static const uint8_t font[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x5B, 0x4F, 0x5B, 0x3E, 0x3E, 0x6B,
    0x4F, 0x6B, 0x3E, 0x1C, 0x3E, 0x7C, 0x3E, 0x1C, 0x18, 0x3C, 0x7E, 0x3C,
    0x18, 0x1C, 0x57, 0x7D, 0x57, 0x1C, 0x1C, 0x5E, 0x7F, 0x5E, 0x1C, 0x00,
    0x18, 0x3C, 0x18, 0x00, 0xFF, 0xE7, 0xC3, 0xE7, 0xFF, 0x00, 0x18, 0x24,
    0x18, 0x00, 0xFF, 0xE7, 0xDB, 0xE7, 0xFF, 0x30, 0x48, 0x3A, 0x06, 0x0E,
    0x26, 0x29, 0x79, 0x29, 0x26, 0x40, 0x7F, 0x05, 0x05, 0x07, 0x40, 0x7F,
    0x05, 0x25, 0x3F, 0x5A, 0x3C, 0xE7, 0x3C, 0x5A, 0x7F, 0x3E, 0x1C, 0x1C,
    0x08, 0x08, 0x1C, 0x1C, 0x3E, 0x7F, 0x14, 0x22, 0x7F, 0x22, 0x14, 0x5F,
    0x5F, 0x00, 0x5F, 0x5F, 0x06, 0x09, 0x7F, 0x01, 0x7F, 0x00, 0x66, 0x89,
    0x95, 0x6A, 0x60, 0x60, 0x60, 0x60, 0x60, 0x94, 0xA2, 0xFF, 0xA2, 0x94,
    0x08, 0x04, 0x7E, 0x04, 0x08, 0x10, 0x20, 0x7E, 0x20, 0x10, 0x08, 0x08,
    0x2A, 0x1C, 0x08, 0x08, 0x1C, 0x2A, 0x08, 0x08, 0x1E, 0x10, 0x10, 0x10,
    0x10, 0x0C, 0x1E, 0x0C, 0x1E, 0x0C, 0x30, 0x38, 0x3E, 0x38, 0x30, 0x06,
    0x0E, 0x3E, 0x0E, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5F,
    0x00, 0x00, 0x00, 0x07, 0x00, 0x07, 0x00, 0x14, 0x7F, 0x14, 0x7F, 0x14,
    0x24, 0x2A, 0x7F, 0x2A, 0x12, 0x23, 0x13, 0x08, 0x64, 0x62, 0x36, 0x49,
    0x56, 0x20, 0x50, 0x00, 0x08, 0x07, 0x03, 0x00, 0x00, 0x1C, 0x22, 0x41,
    0x00, 0x00, 0x41, 0x22, 0x1C, 0x00, 0x2A, 0x1C, 0x7F, 0x1C, 0x2A, 0x08,
    0x08, 0x3E, 0x08, 0x08, 0x00, 0x80, 0x70, 0x30, 0x00, 0x08, 0x08, 0x08,
    0x08, 0x08, 0x00, 0x00, 0x60, 0x60, 0x00, 0x20, 0x10, 0x08, 0x04, 0x02,
    0x3E, 0x51, 0x49, 0x45, 0x3E, // 0
    0x00, 0x42, 0x7F, 0x40, 0x00, // 1
    0x72, 0x49, 0x49, 0x49, 0x46, // 2
    0x21, 0x41, 0x49, 0x4D, 0x33, // 3
    0x18, 0x14, 0x12, 0x7F, 0x10, // 4
    0x27, 0x45, 0x45, 0x45, 0x39, // 5
    0x3C, 0x4A, 0x49, 0x49, 0x31, // 6
    0x41, 0x21, 0x11, 0x09, 0x07, // 7
    0x36, 0x49, 0x49, 0x49, 0x36, // 8
    0x46, 0x49, 0x49, 0x29, 0x1E, // 9
    0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x40, 0x34, 0x00, 0x00, 0x00, 0x08,
    0x14, 0x22, 0x41, 0x14, 0x14, 0x14, 0x14, 0x14, 0x00, 0x41, 0x22, 0x14,
    0x08, 0x02, 0x01, 0x59, 0x09, 0x06, 0x3E, 0x41, 0x5D, 0x59, 0x4E, 0x7C,
    0x12, 0x11, 0x12, 0x7C,       // A
    0x7F, 0x49, 0x49, 0x49, 0x36, // B
    0x3E, 0x41, 0x41, 0x41, 0x22, // C
    0x7F, 0x41, 0x41, 0x41, 0x3E, // D
    0x7F, 0x49, 0x49, 0x49, 0x41, // E
    0x7F, 0x09, 0x09, 0x09, 0x01, // F
    0x3E, 0x41, 0x41, 0x51, 0x73, // G
    0x7F, 0x08, 0x08, 0x08, 0x7F, // H
    0x00, 0x41, 0x7F, 0x41, 0x00, // I
    0x20, 0x40, 0x41, 0x3F, 0x01, // J
    0x7F, 0x08, 0x14, 0x22, 0x41, // K
    0x7F, 0x40, 0x40, 0x40, 0x40, // L
    0x7F, 0x02, 0x1C, 0x02, 0x7F, // M
    0x7F, 0x04, 0x08, 0x10, 0x7F, // N
    0x3E, 0x41, 0x41, 0x41, 0x3E, // O
    0x7F, 0x09, 0x09, 0x09, 0x06, // P
    0x3E, 0x41, 0x51, 0x21, 0x5E, // Q
    0x7F, 0x09, 0x19, 0x29, 0x46, // R
    0x26, 0x49, 0x49, 0x49, 0x32, // S
    0x03, 0x01, 0x7F, 0x01, 0x03, // T
    0x3F, 0x40, 0x40, 0x40, 0x3F, // U
    0x1F, 0x20, 0x40, 0x20, 0x1F, // V
    0x3F, 0x40, 0x38, 0x40, 0x3F, // W
    0x63, 0x14, 0x08, 0x14, 0x63, // X
    0x03, 0x04, 0x78, 0x04, 0x03, // Y
    0x61, 0x59, 0x49, 0x4D, 0x43, // Z
    0x00, 0x7F, 0x41, 0x41, 0x41, 0x02, 0x04, 0x08, 0x10, 0x20, 0x00, 0x41,
    0x41, 0x41, 0x7F, 0x04, 0x02, 0x01, 0x02, 0x04, 0x40, 0x40, 0x40, 0x40,
    0x40, 0x00, 0x03, 0x07, 0x08, 0x00, 0x20, 0x54, 0x54, 0x78, 0x40, // a
    0x7F, 0x28, 0x44, 0x44, 0x38,                                     // b
    0x38, 0x44, 0x44, 0x44, 0x28,                                     // c
    0x38, 0x44, 0x44, 0x28, 0x7F,                                     // d
    0x38, 0x54, 0x54, 0x54, 0x18,                                     // e
    0x00, 0x08, 0x7E, 0x09, 0x02,                                     // f
    0x18, 0xA4, 0xA4, 0x9C, 0x78,                                     // g
    0x7F, 0x08, 0x04, 0x04, 0x78,                                     // h
    0x00, 0x44, 0x7D, 0x40, 0x00,                                     // i
    0x20, 0x40, 0x40, 0x3D, 0x00,                                     // j
    0x7F, 0x10, 0x28, 0x44, 0x00,                                     // k
    0x00, 0x41, 0x7F, 0x40, 0x00,                                     // l
    0x7C, 0x04, 0x78, 0x04, 0x78,                                     // m
    0x7C, 0x08, 0x04, 0x04, 0x78,                                     // n
    0x38, 0x44, 0x44, 0x44, 0x38,                                     // o
    0xFC, 0x18, 0x24, 0x24, 0x18,                                     // p
    0x18, 0x24, 0x24, 0x18, 0xFC,                                     // q
    0x7C, 0x08, 0x04, 0x04, 0x08,                                     // r
    0x48, 0x54, 0x54, 0x54, 0x24,                                     // s
    0x04, 0x04, 0x3F, 0x44, 0x24,                                     // t
    0x3C, 0x40, 0x40, 0x20, 0x7C,                                     // u
    0x1C, 0x20, 0x40, 0x20, 0x1C,                                     // v
    0x3C, 0x40, 0x30, 0x40, 0x3C,                                     // w
    0x44, 0x28, 0x10, 0x28, 0x44,                                     // x
    0x4C, 0x90, 0x90, 0x90, 0x7C,                                     // y
    0x44, 0x64, 0x54, 0x4C, 0x44,                                     // z
    0x00, 0x08, 0x36, 0x41, 0x00, 0x00, 0x00, 0x77, 0x00, 0x00, 0x00, 0x41,
    0x36, 0x08, 0x00, 0x02, 0x01, 0x02, 0x04, 0x02, 0x3C, 0x26, 0x23, 0x26,
    0x3C, 0x1E, 0xA1, 0xA1, 0x61, 0x12, 0x3A, 0x40, 0x40, 0x20, 0x7A, 0x38,
    0x54, 0x54, 0x55, 0x59, 0x21, 0x55, 0x55, 0x79, 0x41, 0x21, 0x54, 0x54,
    0x78, 0x41, 0x21, 0x55, 0x54, 0x78, 0x40, 0x20, 0x54, 0x55, 0x79, 0x40,
    0x0C, 0x1E, 0x52, 0x72, 0x12, 0x39, 0x55, 0x55, 0x55, 0x59, 0x39, 0x54,
    0x54, 0x54, 0x59, 0x39, 0x55, 0x54, 0x54, 0x58, 0x00, 0x00, 0x45, 0x7C,
    0x41, 0x00, 0x02, 0x45, 0x7D, 0x42, 0x00, 0x01, 0x45, 0x7C, 0x40, 0xF0,
    0x29, 0x24, 0x29, 0xF0, 0xF0, 0x28, 0x25, 0x28, 0xF0, 0x7C, 0x54, 0x55,
    0x45, 0x00, 0x20, 0x54, 0x54, 0x7C, 0x54, 0x7C, 0x0A, 0x09, 0x7F, 0x49,
    0x32, 0x49, 0x49, 0x49, 0x32, 0x32, 0x48, 0x48, 0x48, 0x32, 0x32, 0x4A,
    0x48, 0x48, 0x30, 0x3A, 0x41, 0x41, 0x21, 0x7A, 0x3A, 0x42, 0x40, 0x20,
    0x78, 0x00, 0x9D, 0xA0, 0xA0, 0x7D, 0x39, 0x44, 0x44, 0x44, 0x39, 0x3D,
    0x40, 0x40, 0x40, 0x3D, 0x3C, 0x24, 0xFF, 0x24, 0x24, 0x48, 0x7E, 0x49,
    0x43, 0x66, 0x2B, 0x2F, 0xFC, 0x2F, 0x2B, 0xFF, 0x09, 0x29, 0xF6, 0x20,
    0xC0, 0x88, 0x7E, 0x09, 0x03, 0x20, 0x54, 0x54, 0x79, 0x41, 0x00, 0x00,
    0x44, 0x7D, 0x41, 0x30, 0x48, 0x48, 0x4A, 0x32, 0x38, 0x40, 0x40, 0x22,
    0x7A, 0x00, 0x7A, 0x0A, 0x0A, 0x72, 0x7D, 0x0D, 0x19, 0x31, 0x7D, 0x26,
    0x29, 0x29, 0x2F, 0x28, 0x26, 0x29, 0x29, 0x29, 0x26, 0x30, 0x48, 0x4D,
    0x40, 0x20, 0x38, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x38,
    0x2F, 0x10, 0xC8, 0xAC, 0xBA, 0x2F, 0x10, 0x28, 0x34, 0xFA, 0x00, 0x00,
    0x7B, 0x00, 0x00, 0x08, 0x14, 0x2A, 0x14, 0x22, 0x22, 0x14, 0x2A, 0x14,
    0x08, 0xAA, 0x00, 0x55, 0x00, 0xAA, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x00,
    0x00, 0x00, 0xFF, 0x00, 0x10, 0x10, 0x10, 0xFF, 0x00, 0x14, 0x14, 0x14,
    0xFF, 0x00, 0x10, 0x10, 0xFF, 0x00, 0xFF, 0x10, 0x10, 0xF0, 0x10, 0xF0,
    0x14, 0x14, 0x14, 0xFC, 0x00, 0x14, 0x14, 0xF7, 0x00, 0xFF, 0x00, 0x00,
    0xFF, 0x00, 0xFF, 0x14, 0x14, 0xF4, 0x04, 0xFC, 0x14, 0x14, 0x17, 0x10,
    0x1F, 0x10, 0x10, 0x1F, 0x10, 0x1F, 0x14, 0x14, 0x14, 0x1F, 0x00, 0x10,
    0x10, 0x10, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x10, 0x10, 0x10, 0x10,
    0x1F, 0x10, 0x10, 0x10, 0x10, 0xF0, 0x10, 0x00, 0x00, 0x00, 0xFF, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0xFF, 0x10, 0x00, 0x00,
    0x00, 0xFF, 0x14, 0x00, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0x00, 0x1F, 0x10,
    0x17, 0x00, 0x00, 0xFC, 0x04, 0xF4, 0x14, 0x14, 0x17, 0x10, 0x17, 0x14,
    0x14, 0xF4, 0x04, 0xF4, 0x00, 0x00, 0xFF, 0x00, 0xF7, 0x14, 0x14, 0x14,
    0x14, 0x14, 0x14, 0x14, 0xF7, 0x00, 0xF7, 0x14, 0x14, 0x14, 0x17, 0x14,
    0x10, 0x10, 0x1F, 0x10, 0x1F, 0x14, 0x14, 0x14, 0xF4, 0x14, 0x10, 0x10,
    0xF0, 0x10, 0xF0, 0x00, 0x00, 0x1F, 0x10, 0x1F, 0x00, 0x00, 0x00, 0x1F,
    0x14, 0x00, 0x00, 0x00, 0xFC, 0x14, 0x00, 0x00, 0xF0, 0x10, 0xF0, 0x10,
    0x10, 0xFF, 0x10, 0xFF, 0x14, 0x14, 0x14, 0xFF, 0x14, 0x10, 0x10, 0x10,
    0x1F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x10, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0xFF, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x38, 0x44, 0x44, 0x38,
    0x44, 0x7C, 0x2A, 0x2A, 0x3E, 0x14, 0x7E, 0x02, 0x02, 0x06, 0x06, 0x02,
    0x7E, 0x02, 0x7E, 0x02, 0x63, 0x55, 0x49, 0x41, 0x63, 0x38, 0x44, 0x44,
    0x3C, 0x04, 0x40, 0x7E, 0x20, 0x1E, 0x20, 0x06, 0x02, 0x7E, 0x02, 0x02,
    0x99, 0xA5, 0xE7, 0xA5, 0x99, 0x1C, 0x2A, 0x49, 0x2A, 0x1C, 0x4C, 0x72,
    0x01, 0x72, 0x4C, 0x30, 0x4A, 0x4D, 0x4D, 0x30, 0x30, 0x48, 0x78, 0x48,
    0x30, 0xBC, 0x62, 0x5A, 0x46, 0x3D, 0x3E, 0x49, 0x49, 0x49, 0x00, 0x7E,
    0x01, 0x01, 0x01, 0x7E, 0x2A, 0x2A, 0x2A, 0x2A, 0x2A, 0x44, 0x44, 0x5F,
    0x44, 0x44, 0x40, 0x51, 0x4A, 0x44, 0x40, 0x40, 0x44, 0x4A, 0x51, 0x40,
    0x00, 0x00, 0xFF, 0x01, 0x03, 0xE0, 0x80, 0xFF, 0x00, 0x00, 0x08, 0x08,
    0x6B, 0x6B, 0x08, 0x36, 0x12, 0x36, 0x24, 0x36, 0x06, 0x0F, 0x09, 0x0F,
    0x06, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x10, 0x10, 0x00, 0x30,
    0x40, 0xFF, 0x01, 0x01, 0x00, 0x1F, 0x01, 0x01, 0x1E, 0x00, 0x19, 0x1D,
    0x17, 0x12, 0x00, 0x3C, 0x3C, 0x3C, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00,
};

/**
 * Sets the LCD reset.
 */
static void setLCDReset() {
  // Set LCD reset low (active low)
  BITCLEAR(GPIOE->ODR, 10);
}

/**
 * Unsets the LCD reset.
 */
static void unsetLCDReset() {
  // Set LCD reset high
  BITSET(GPIOE->ODR, 10);
}

/**
 * Sets the LCD chip select.
 */
static void setLCDCS() {
  // Set chip select low (active low)
  BITCLEAR(GPIOE->ODR, 12);
}

/**
 * Unsets the LCD chip select.
 */
static void unsetLCDCS() {
  // Set chip select to high
  BITSET(GPIOE->ODR, 12);
}

/**
 * Sets the LCD in command mode.
 */
static void setLCDCommand() {
  // Set LCD register select low (command)
  BITCLEAR(GPIOE->ODR, 11);
}

/**
 * Sets the LCD in data mode.
 */
static void setLCDData() {
  // Set LCD register select high (data)
  BITSET(GPIOE->ODR, 11);
}

/**
 * Sends a command to the ST7735 driver
 * for the LCD screen on the BOOSTXL-EDUMKII.
 *
 * @param command The command to send
 */
static void sendLCDCommand(uint8_t command) {
  setLCDCS();
  // Wait for SPI1 to not be busy and the transmit
  // buffer to be empty
  while (BITCHECK(SPI1->SR, 7) == 1 || BITCHECK(SPI1->SR, 1) == 0)
    ;

  setLCDCommand();

  writeSPI1(command);

  // Wait for SPI1 to not be busy and the transmit
  // buffer to be empty
  while (BITCHECK(SPI1->SR, 7) == 1 || BITCHECK(SPI1->SR, 1) == 0)
    ;

  setLCDData();
  unsetLCDCS();
}

/**
 * Sends a piece of data to the ST7735 driver
 * for the LCD screen on the BOOSTXL-EDUMKII.
 *
 * @param data The data to send
 */
static void sendLCDData(uint8_t data) {
  setLCDCS();
  // Wait for SPI1 to not be busy and the transmit
  // buffer to be empty
  while (BITCHECK(SPI1->SR, 7) == 1 || BITCHECK(SPI1->SR, 1) == 0)
    ;

  setLCDData();

  writeSPI1(data);

  // Wait for SPI1 to not be busy and the transmit
  // buffer to be empty
  while (BITCHECK(SPI1->SR, 7) == 1 || BITCHECK(SPI1->SR, 1) == 0)
    ;
  unsetLCDCS();
}

/**
 * Sets the frame that we can render to.
 *
 * @param sX The starting horizontal coordinate
 * that can be rendered to
 * @param sY The starting vertical coordinate
 * that can be rendered to
 * @param eX The ending horizontal coordinate
 * that can be rendered to
 * @param eY The ending vertical coordinate
 * that can be rendered to
 */
static void setRenderFrame(uint8_t sX, uint8_t sY, uint8_t eX, uint8_t eY) {
  sendLCDCommand(ST7735_CASET);
  sendLCDData(0x0);
  sendLCDData(sX);
  sendLCDData(0x0);
  sendLCDData(eX);

  sendLCDCommand(ST7735_RASET);
  sendLCDData(0x0);
  sendLCDData(sY);
  sendLCDData(0x0);
  sendLCDData(eY);
}

void initLCD() {
  setLCDData();

  // Reset signal must be set for 10 μs minimum
  setLCDReset();
  delayMS(50);

  // Reset lasts 120 ms max
  unsetLCDReset();
  delayMS(150);

  // Exit sleep mode
  // Must wait 120 ms minimum before sending the next command
  sendLCDCommand(ST7735_SLPOUT);
  delayMS(200);

  // Set a gamma curve of 2.2
  sendLCDCommand(ST7735_GAMSET);
  sendLCDData(0x4);

  // Set GVDD to 4.30V
  // Set AVDD to 2.5uA
  sendLCDCommand(ST7735_PWCTR1);
  sendLCDData(0xA);
  sendLCDData(0x0);

  // Use a 16-bit color pixel
  sendLCDCommand(ST7735_COLMOD);
  sendLCDData(0x5);
  delayMS(10);

  // Use inverted row and column address order
  sendLCDCommand(ST7735_MADCTL);
  sendLCDData(0xC0);

  // Ensure normal display mode is on
  sendLCDCommand(ST7735_NORON);

  setRenderFrame(0, 0, CFAF_WIDTH, CFAF_HEIGHT);

  // Fill the screen with red pixels
  sendLCDCommand(ST7735_RAMWR);

  for (int i = 0; i <= CFAF_WIDTH; ++i) {
    for (int j = 0; j <= CFAF_HEIGHT; ++j) {
      sendLCDData(0x0);
      sendLCDData(0xF8);
    }
  }

  delayMS(10);

  // Turn the display on
  sendLCDCommand(ST7735_DISPON);

  delayMS(10);
}

void renderChar(uint8_t x, uint8_t y, char c, uint16_t charColor,
                uint16_t bgColor) {
  const uint8_t endX = x + 5;
  const uint8_t endY = y + 7;

  if (x > CFAF_WIDTH || endX > CFAF_WIDTH || y > CFAF_HEIGHT ||
      endY > CFAF_HEIGHT) {
    return;
  }

  setRenderFrame(x, y, endX, endY);
  sendLCDCommand(ST7735_RAMWR);

  uint8_t line = 1; // Start with the first row
  // Loop through each row (8 rows for each character)
  for (int row = 0; row < 8; ++row) {

    // 5 columns for each character in the font
    for (int col = 0; col < 5; ++col) {
      if (font[(c * 5) + col] & line) {
        // Send the color for the pixel
        sendLCDData((uint8_t)(charColor >> 8));
        sendLCDData((uint8_t)(charColor));
      } else {
        // Send background color
        sendLCDData((uint8_t)(bgColor >> 8));
        sendLCDData((uint8_t)(bgColor));
      }
    }

    // Send background color
    sendLCDData((uint8_t)(bgColor >> 8));
    sendLCDData((uint8_t)(bgColor));
    line <<= 1; // Move to the next line
  }

  sendLCDCommand(ST7735_NOP);
}

unsigned long renderString(uint8_t x, uint8_t y, const char *text,
                           uint16_t textColor, uint16_t bgColor) {
  unsigned long cnt = 0;
  if (y > 10)
    return 0;

  // loop to run through string
  while (*text) {
    if (x > 10)
      return cnt;
    renderChar(x * 6, y * 10, *text++, textColor, bgColor);
    ++x;
    ++cnt;
  }

  return cnt;
}

// Convert a 24-bit color to 16-bit
uint16_t color24to16(uint8_t r, uint8_t g, uint8_t b) {
  // Lose lower three bits of precision for red,
  // lower two bits for blue,
  // and lower three bits for green
  return ((((uint16_t)r & 0xF8) << 8) | (((uint16_t)g & 0xFC) << 3) |
          ((uint16_t)b >> 3));
}
